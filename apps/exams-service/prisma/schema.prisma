// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/exams-client"
}

datasource db {
  provider = "postgresql"
  url      = env("EXAMS_DATABASE_URL")
}

enum ExamStatus {
  draft
  published
  in_progress
  completed
  cancelled
}

enum SubmissionStatus {
  in_progress
  submitted
  cancelled
  graded
}

model Exam {
  exam_id     Int           @id @default(autoincrement())
  class_id    Int
  title       String        @db.VarChar
  start_time  DateTime      @db.Timestamp(6)
  end_time    DateTime      @db.Timestamp(6)
  status      ExamStatus    @default(draft)
  created_by  Int
  created_at  DateTime      @default(now()) @db.Timestamp(6)
  
  submissions    Submission[]
  question_exams QuestionExam[]

  @@map("exams")
}

enum QuestionType {
  multiple_choice
  essay
}

enum QuestionDifficulty {
  easy
  medium
  hard
}

model QuestionCategory {
  category_id   Int        @id @default(autoincrement())
  name          String     @unique @db.VarChar(255)
  description   String?    @db.Text
  created_at    DateTime   @default(now()) @db.Timestamp(6)
  updated_at    DateTime   @updatedAt @db.Timestamp(6)
  
  questions     Question[]

  @@map("question_categories")
}

model Question {
  question_id        Int                  @id @default(autoincrement())
  content            String               @db.Text
  type               QuestionType         @default(multiple_choice)
  difficulty         QuestionDifficulty?  @default(medium)
  category_id        Int?
  
  // Multiple choice specific fields
  is_multiple_answer Boolean              @default(false) // true = multiple answers, false = single answer
  options            Json?

  // Metadata
  created_by         Int                  // Teacher ID who created this question
  is_public          Boolean              @default(false) // Can other teachers use this?
  created_at         DateTime             @default(now()) @db.Timestamp(6)
  updated_at         DateTime             @updatedAt @db.Timestamp(6)
  
  // Relations
  category           QuestionCategory?    @relation(fields: [category_id], references: [category_id], onDelete: SetNull)
  submission_answers SubmissionAnswer[]
  question_exams     QuestionExam[]

  @@index([created_by])
  @@index([type])
  @@index([category_id])
  @@index([difficulty])
  @@map("questions")
}

model QuestionExam {
  question_id Int
  exam_id     Int
  order       Int @default(1)
  points      Int @default(1)
  
  question Question @relation(fields: [question_id], references: [question_id], onDelete: Cascade)
  exam     Exam     @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)

  @@id([question_id, exam_id])
  @@map("question_exams")
}

model Submission {
  submission_id     Int                @id @default(autoincrement())
  exam_id           Int
  student_id        Int
  submitted_at      DateTime           @default(now()) @db.Timestamp(6)
  score             Decimal?           @db.Decimal(5, 2) // Score out of total points
  teacher_feedback  String?            @db.Text
  graded_at         DateTime?          @db.Timestamp(6)
  graded_by         Int?
  status            SubmissionStatus         @default(in_progress)
  
  exam    Exam               @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)
  answers SubmissionAnswer[]

  @@unique([exam_id, student_id])
  @@map("submissions")
}

model SubmissionAnswer {
  answer_id      Int      @id @default(autoincrement())
  submission_id  Int
  question_id    Int
  answer_content String   @db.Text
  is_correct     Boolean  @default(false)
  points_earned  Decimal  @default(0) @db.Decimal(5, 2)
  comment        String?  @db.Text
  comment_by     Int?
  
  submission Submission @relation(fields: [submission_id], references: [submission_id], onDelete: Cascade)
  question   Question   @relation(fields: [question_id], references: [question_id], onDelete: Cascade)

  @@map("submission_answers")
}
